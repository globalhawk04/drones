<!-- FILE: templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Architect | Digital Twin</title>
    
    <!-- STYLING -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        canvas { max-height: 200px; }
    </style>

    <!-- 3D & ANIMATION LIBS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- CHARTING LIB (For Physics) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="flex h-screen">

    <!-- LEFT SIDEBAR: CONTROL CENTER -->
    <div class="w-[400px] glass-panel flex flex-col z-10 h-full border-r border-gray-700 shadow-2xl">
        
        <!-- HEADER -->
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">
                Drone Architect
            </h1>
            <div class="flex gap-2 mt-4 bg-gray-800 p-1 rounded-lg">
                <button onclick="switchTab('build')" id="tab-build" class="flex-1 py-2 text-xs font-bold rounded bg-blue-600 text-white transition-all">
                    üõ†Ô∏è BUILD
                </button>
                <button onclick="switchTab('sim')" id="tab-sim" class="flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all">
                    üìà SIMULATION
                </button>
            </div>
        </div>

        <!-- MODE: ASSEMBLY -->
        <div id="panel-build" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 bg-gray-800/50 text-xs font-mono text-gray-400 border-b border-gray-700">
                ASSEMBLY SEQUENCE
            </div>
            <div id="steps-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Steps injected via JS -->
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-between items-center bg-gray-900/80">
                <button onclick="prevStep()" class="text-gray-400 hover:text-white px-3 py-1 text-sm">‚óÄ Prev</button>
                <span id="step-counter" class="text-xs font-mono text-blue-400">0 / 0</span>
                <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded text-sm font-bold shadow-lg shadow-blue-500/20">Next ‚ñ∂</button>
            </div>
        </div>

        <!-- MODE: SIMULATION -->
        <div id="panel-sim" class="hidden flex-1 flex flex-col overflow-y-auto p-4 space-y-6">
            
            <!-- Flight Card -->
            <div class="bg-gray-800/80 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-bold text-teal-400 mb-2">FLIGHT DYNAMICS</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-900/50 p-2 rounded">
                        <div class="text-[10px] text-gray-500">TWR</div>
                        <div class="text-xl font-mono font-bold text-white" id="val-twr">--</div>
                    </div>
                    <div class="bg-gray-900/50 p-2 rounded">
                        <div class="text-[10px] text-gray-500">HOVER THROTTLE</div>
                        <div class="text-xl font-mono font-bold text-green-400" id="val-hover">--</div>
                    </div>
                </div>
            </div>

            <!-- Altitude Graph -->
            <div class="bg-gray-800/80 rounded-lg p-4 border border-gray-700">
                <h3 class="text-xs font-bold text-gray-400 mb-2">ALTITUDE HOLD TEST (PyBullet)</h3>
                <canvas id="chart-altitude"></canvas>
            </div>

            <!-- Motor Output Graph -->
            <div class="bg-gray-800/80 rounded-lg p-4 border border-gray-700">
                <h3 class="text-xs font-bold text-gray-400 mb-2">PID MOTOR RESPONSE</h3>
                <canvas id="chart-motors"></canvas>
            </div>

            <div class="text-xs text-gray-500 italic text-center mt-4">
                * Data generated from physics engine validation run.
            </div>
        </div>
    </div>

    <!-- RIGHT: 3D VIEWPORT -->
    <div class="flex-1 relative bg-gradient-to-b from-gray-900 via-[#111827] to-black">
        <div id="3d-container" class="w-full h-full cursor-move"></div>
        
        <!-- Overlay Info -->
        <div class="absolute top-6 right-6 text-right pointer-events-none">
            <h2 class="text-4xl font-black text-white/10 select-none">DIGITAL TWIN</h2>
            <div id="part-label" class="text-xl font-bold text-blue-500 opacity-0 transition-opacity">
                FRAME CHASSIS
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // 1. DATA INJECTION (PYTHON REPLACES THESE PLACEHOLDERS)
        // =====================================================================
        
        // Base64 STLs generated by OpenSCAD
        const ASSETS = {
            frame: "[[FRAME_B64]]", 
            motor: "[[MOTOR_B64]]", 
            fc: "[[FC_B64]]",
            prop: "[[PROP_B64]]", 
            battery: "[[BATTERY_B64]]", 
            camera: "[[CAMERA_B64]]"
        };
        
        // Data from AI and Simulation
        const STEPS = [[STEPS_JSON]]; // Array of {step: "", detail: ""}
        const FLIGHT_LOG = [[FLIGHT_LOG_JSON]]; // Object { time: [], height: [], motors: [] }
        const STATS = [[PHYSICS_JSON]]; // Object { twr: 1.5, hover_throttle_percent: 12, ... }
        const WHEELBASE = [[WHEELBASE]];

        // =====================================================================
        // 2. STATE MANAGEMENT
        // =====================================================================
        let currentStep = -1;
        let mode = 'build'; // 'build' or 'sim'
        let droneGroup = new THREE.Group(); // Holds the entire drone
        const parts = { motors: [], props: [] }; // References to meshes

        // =====================================================================
        // 3. UI LOGIC
        // =====================================================================
        
        function switchTab(newMode) {
            mode = newMode;
            document.getElementById('tab-build').className = mode === 'build' ? 'flex-1 py-2 text-xs font-bold rounded bg-blue-600 text-white transition-all' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all';
            document.getElementById('tab-sim').className = mode === 'sim' ? 'flex-1 py-2 text-xs font-bold rounded bg-teal-600 text-white transition-all' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all';
            
            document.getElementById('panel-build').className = mode === 'build' ? 'flex-1 flex flex-col overflow-hidden' : 'hidden';
            document.getElementById('panel-sim').className = mode === 'sim' ? 'flex-1 flex flex-col overflow-y-auto p-4 space-y-6' : 'hidden';

            if(mode === 'sim') {
                // Assemble everything for the "Flight" view
                animateAllToFinal();
                startHoverAnimation();
                initCharts(); // Render graphs only when visible
            } else {
                stopHoverAnimation();
                resetToStep(currentStep); // Go back to exploded view
            }
        }

        // =====================================================================
        // 4. THREE.JS SCENE SETUP
        // =====================================================================
        const scene = new THREE.Scene();
        // Fog for depth
        scene.fog = new THREE.FogExp2(0x0f172a, 0.002);

        const camera = new THREE.PerspectiveCamera(50, (window.innerWidth - 400) / window.innerHeight, 0.1, 1000);
        camera.position.set(200, 200, 200);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - 400, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('3d-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // Lights
        const ambLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const blueLight = new THREE.PointLight(0x3b82f6, 1, 500);
        blueLight.position.set(-50, 50, -50);
        scene.add(blueLight);

        // Grid
        const gridHelper = new THREE.GridHelper(500, 50, 0x1e293b, 0x0f172a);
        scene.add(gridHelper);

        scene.add(droneGroup);

        // =====================================================================
        // 5. ASSET LOADING & PLACEMENT
        // =====================================================================
        const loader = new THREE.STLLoader();

        function loadPart(b64, color, name) {
            return new Promise(resolve => {
                if (!b64 || b64.length < 50) resolve(null);
                loader.load(b64, (geometry) => {
                    geometry.center(); // Center geometry for easier rotation
                    const material = new THREE.MeshStandardMaterial({ 
                        color: color, 
                        roughness: 0.4, 
                        metalness: 0.6 
                    });
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = { originalZ: 0, name: name };
                    mesh.visible = false; // Hide initially
                    resolve(mesh);
                });
            });
        }

        async function initDrone() {
            // 1. Frame (Center)
            parts.frame = await loadPart(ASSETS.frame, 0x334155, "Carbon Frame");
            if(parts.frame) droneGroup.add(parts.frame);

            // 2. Motors (4 Corners)
            const offset = (WHEELBASE / 2) * 0.707;
            const pos = [
                {x: offset, y: offset}, {x: -offset, y: offset}, 
                {x: -offset, y: -offset}, {x: offset, y: -offset}
            ];
            
            const motorTemplate = await loadPart(ASSETS.motor, 0x94a3b8, "Brushless Motor");
            const propTemplate = await loadPart(ASSETS.prop, 0x06b6d4, "Propeller");

            if(motorTemplate) {
                pos.forEach(p => {
                    const m = motorTemplate.clone();
                    m.position.set(p.x, 0, p.y); // Y is UP in Three.js? No, usually Y is up, but standard CAD Z is up. 
                    // Let's assume Z is UP for drone CAD.
                    // ThreeJS: Y is Up. OpenSCAD: Z is Up. 
                    // STLLoader usually orients Z up -> Y up. Let's fix orientation.
                    m.rotation.x = -Math.PI / 2; 
                    m.position.set(p.x, 10, p.y); // Start floated
                    m.visible = false;
                    parts.motors.push(m);
                    droneGroup.add(m);

                    if(propTemplate) {
                        const pr = propTemplate.clone();
                        pr.rotation.x = -Math.PI / 2;
                        pr.position.set(p.x, 25, p.y);
                        pr.visible = false;
                        parts.props.push(pr);
                        droneGroup.add(pr);
                    }
                });
            }

            // 3. FC Stack
            parts.fc = await loadPart(ASSETS.fc, 0xf43f5e, "Flight Controller");
            if(parts.fc) {
                parts.fc.rotation.x = -Math.PI / 2;
                parts.fc.position.set(0, 15, 0);
                parts.fc.visible = false;
                droneGroup.add(parts.fc);
            }

            // 4. Battery
            parts.battery = await loadPart(ASSETS.battery, 0xfacc15, "LiPo Battery");
            if(parts.battery) {
                parts.battery.rotation.x = -Math.PI / 2;
                parts.battery.position.set(0, -20, 0); // Below frame
                parts.battery.visible = false;
                droneGroup.add(parts.battery);
            }

            // Correct Frame Rotation
            if(parts.frame) parts.frame.rotation.x = -Math.PI / 2;

            renderStepList();
        }

        initDrone();

        // =====================================================================
        // 6. BUILD MODE LOGIC (GSAP ANIMATION)
        // =====================================================================
        
        function renderStepList() {
            const container = document.getElementById('steps-container');
            container.innerHTML = '';
            
            STEPS.forEach((s, i) => {
                const div = document.createElement('div');
                div.id = `step-card-${i}`;
                div.className = `p-3 rounded border border-gray-700 bg-gray-800/50 hover:bg-gray-700 cursor-pointer transition-colors opacity-50`;
                div.onclick = () => jumpToStep(i);
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-mono text-blue-500 font-bold">${i+1}.</span>
                        <span class="font-bold text-gray-200 text-sm">${s.step}</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1 pl-5 hidden" id="step-detail-${i}">${s.detail}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById('step-counter').innerText = `Start`;
        }

        function jumpToStep(index) {
            currentStep = index;
            resetToStep(index);
        }

        function nextStep() {
            if(currentStep < STEPS.length - 1) {
                currentStep++;
                highlightStepUI(currentStep);
                animatePartsForStep(currentStep);
            }
        }

        function prevStep() {
            if(currentStep > -1) {
                currentStep--;
                resetToStep(currentStep);
            }
        }

        function highlightStepUI(index) {
            // Reset all
            STEPS.forEach((_, i) => {
                const card = document.getElementById(`step-card-${i}`);
                const detail = document.getElementById(`step-detail-${i}`);
                card.classList.add('opacity-50', 'border-gray-700');
                card.classList.remove('border-blue-500', 'bg-gray-700', 'opacity-100');
                detail.classList.add('hidden');
            });

            if(index > -1) {
                const card = document.getElementById(`step-card-${index}`);
                const detail = document.getElementById(`step-detail-${index}`);
                card.classList.remove('opacity-50', 'border-gray-700');
                card.classList.add('border-blue-500', 'bg-gray-700', 'opacity-100');
                detail.classList.remove('hidden');
                
                // Scroll to view
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                document.getElementById('step-counter').innerText = `${index + 1} / ${STEPS.length}`;
            } else {
                document.getElementById('step-counter').innerText = "Start";
            }
        }

        function animatePartsForStep(index) {
            if(index === -1) return;
            const text = (STEPS[index].step + " " + STEPS[index].detail).toLowerCase();
            const label = document.getElementById('part-label');

            // Helper to animate opacity and position
            const show = (mesh, name, finalY) => {
                if(!mesh) return;
                mesh.visible = true;
                label.innerText = name.toUpperCase();
                label.style.opacity = 1;
                setTimeout(() => label.style.opacity = 0, 2000);
                
                // GSAP Animation: Fly in from Z-axis (which is Y in ThreeJS world due to rotation)
                gsap.fromTo(mesh.position, 
                    { y: finalY + 50 }, 
                    { y: finalY, duration: 1, ease: "bounce.out" }
                );
            };

            if(text.includes('frame') || text.includes('plate') || text.includes('arm')) {
                if(parts.frame) show(parts.frame, "Carbon Fiber Frame", 0);
            }
            if(text.includes('motor')) {
                parts.motors.forEach((m, i) => {
                    setTimeout(() => show(m, "Motor " + (i+1), 5), i * 100);
                });
            }
            if(text.includes('stack') || text.includes('fc') || text.includes('controller')) {
                if(parts.fc) show(parts.fc, "Flight Controller", 8);
            }
            if(text.includes('battery') || text.includes('strap')) {
                if(parts.battery) show(parts.battery, "Battery", -15);
            }
            if(text.includes('prop')) {
                parts.props.forEach((p, i) => {
                    setTimeout(() => show(p, "Propeller", 15), i * 100);
                });
            }
        }

        // Snap everything to state at index X
        function resetToStep(index) {
            highlightStepUI(index);
            // Hide everything first
            droneGroup.traverse(o => { if(o.isMesh) o.visible = false; });
            
            // Re-show based on history
            for(let i=0; i<=index; i++) {
                const text = (STEPS[i].step + " " + STEPS[i].detail).toLowerCase();
                if(text.includes('frame')) if(parts.frame) parts.frame.visible = true;
                if(text.includes('motor')) parts.motors.forEach(m => { m.visible = true; m.position.y = 5; });
                if(text.includes('fc')) if(parts.fc) { parts.fc.visible = true; parts.fc.position.y = 8; }
                if(text.includes('battery')) if(parts.battery) { parts.battery.visible = true; parts.battery.position.y = -15; }
                if(text.includes('prop')) parts.props.forEach(p => { p.visible = true; p.position.y = 15; });
            }
        }

        function animateAllToFinal() {
            // Show everything in final position for SIM mode
            droneGroup.traverse(o => { if(o.isMesh) o.visible = true; });
        }

        // =====================================================================
        // 7. SIMULATION MODE LOGIC (GRAPHS & HOVER)
        // =====================================================================
        
        let hoverTweens = [];
        
        function startHoverAnimation() {
            // Stop orbit auto rotate so we can see the physics wobble
            controls.autoRotate = false;
            
            // Make the whole drone hover-float
            const t1 = gsap.to(droneGroup.position, { y: 5, duration: 2, yoyo: true, repeat: -1, ease: "sine.inOut" });
            // Add random PID jitter
            const t2 = gsap.to(droneGroup.rotation, { x: 0.05, z: -0.05, duration: 0.5, yoyo: true, repeat: -1, ease: "linear" });
            
            // Spin props
            parts.props.forEach(p => {
                const t = gsap.to(p.rotation, { z: Math.PI * 10, duration: 0.2, repeat: -1, ease: "none" });
                hoverTweens.push(t);
            });
            hoverTweens.push(t1, t2);
        }

        function stopHoverAnimation() {
            controls.autoRotate = true;
            hoverTweens.forEach(t => t.kill());
            hoverTweens = [];
            gsap.to(droneGroup.position, { y: 0, duration: 0.5 });
            gsap.to(droneGroup.rotation, { x: 0, z: 0, duration: 0.5 });
        }

        function initCharts() {
            if(window.altChart) return; // Already inited

            // Inject Physics Stats
            document.getElementById('val-twr').innerText = STATS.twr || "N/A";
            document.getElementById('val-hover').innerText = (STATS.hover_throttle_percent || 0) + "%";

            // Prepare Data from FLIGHT_LOG
            // Fallback mock data if log is empty (for demo safety)
            const times = FLIGHT_LOG.time || [0,1,2,3,4,5];
            const heights = FLIGHT_LOG.height || [0, 0.5, 1.0, 1.0, 1.0, 0];
            const throttle = FLIGHT_LOG.throttle_avg || [0, 0.4, 0.45, 0.45, 0.45, 0];

            // 1. Altitude Chart
            const ctxAlt = document.getElementById('chart-altitude').getContext('2d');
            window.altChart = new Chart(ctxAlt, {
                type: 'line',
                data: {
                    labels: times.map(t => t.toFixed(1) + "s"),
                    datasets: [{
                        label: 'Altitude (m)',
                        data: heights,
                        borderColor: '#2dd4bf', // Teal
                        backgroundColor: 'rgba(45, 212, 191, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            // 2. Motor Chart
            const ctxMotor = document.getElementById('chart-motors').getContext('2d');
            window.motorChart = new Chart(ctxMotor, {
                type: 'line',
                data: {
                    labels: times.map(t => t.toFixed(1) + "s"),
                    datasets: [{
                        label: 'Avg Motor Output (0-1)',
                        data: throttle,
                        borderColor: '#facc15', // Yellow
                        borderWidth: 1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { min: 0, max: 1, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // =====================================================================
        // 8. RENDER LOOP
        // =====================================================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 400) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 400, window.innerHeight);
        });

    </script>
</body>
</html>